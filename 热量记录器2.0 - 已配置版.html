<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¥— æ²™æ‹‰çƒ­é‡è®°å½•å™¨ 2.0 - Phase 1</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Supabaseå®¢æˆ·ç«¯ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        /* ç®€åŒ–æ ·å¼ï¼Œä¿æŒæ ¸å¿ƒåŠŸèƒ½ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .meal-section { margin-bottom: 20px; }
        .meal-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .food-item { display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; margin-bottom: 5px; border-radius: 5px; }
        .add-food-form { display: flex; gap: 10px; margin-top: 10px; }
        .add-food-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .add-food-btn { padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .stats { text-align: center; font-size: 24px; margin: 20px 0; }
        .loading { text-align: center; padding: 40px; }
        .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="loading" id="loading">æ­£åœ¨åˆå§‹åŒ–...</div>
        
        <div class="error" id="errorMessage" style="display: none;"></div>
        <div class="success" id="successMessage" style="display: none;"></div>
        
        <div id="mainContent" style="display: none;">
            <div class="header">
                <h1>ğŸ¥— çƒ­é‡è®°å½•å™¨ 2.0</h1>
                <p>Phase 1: æ•°æ®åº“è¿ç§»æµ‹è¯•ç‰ˆ</p>
            </div>
            
            <div class="card">
                <h2>ğŸ“Š ä»Šæ—¥ç»Ÿè®¡</h2>
                <div class="stats" id="totalCalories">0 kcal</div>
                <div>ç›®æ ‡: <span id="dailyGoal">2000</span> kcal | å‰©ä½™: <span id="remainingCalories">2000</span> kcal</div>
            </div>
            
            <div class="card">
                <div class="meal-section">
                    <div class="meal-header">
                        <h3>ğŸŒ… æ—©é¤</h3>
                        <span id="breakfastTotal">0 kcal</span>
                    </div>
                    <div id="breakfastList"></div>
                    <div class="add-food-form">
                        <input type="text" class="add-food-input" id="breakfastInput" placeholder="é£Ÿç‰©åç§°">
                        <input type="number" class="add-food-input" id="breakfastCalories" placeholder="çƒ­é‡" style="width: 80px;">
                        <button class="add-food-btn" onclick="addFood('breakfast')">æ·»åŠ </button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="meal-section">
                    <div class="meal-header">
                        <h3>â˜€ï¸ åˆé¤</h3>
                        <span id="lunchTotal">0 kcal</span>
                    </div>
                    <div id="lunchList"></div>
                    <div class="add-food-form">
                        <input type="text" class="add-food-input" id="lunchInput" placeholder="é£Ÿç‰©åç§°">
                        <input type="number" class="add-food-input" id="lunchCalories" placeholder="çƒ­é‡" style="width: 80px;">
                        <button class="add-food-btn" onclick="addFood('lunch')">æ·»åŠ </button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="meal-section">
                    <div class="meal-header">
                        <h3>ğŸŒ™ æ™šé¤</h3>
                        <span id="dinnerTotal">0 kcal</span>
                    </div>
                    <div id="dinnerList"></div>
                    <div class="add-food-form">
                        <input type="text" class="add-food-input" id="dinnerInput" placeholder="é£Ÿç‰©åç§°">
                        <input type="number" class="add-food-input" id="dinnerCalories" placeholder="çƒ­é‡" style="width: 80px;">
                        <button class="add-food-btn" onclick="addFood('dinner')">æ·»åŠ </button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>ğŸ“… æœ€è¿‘è®°å½•</h2>
                <div id="historyList">æš‚æ— å†å²è®°å½•</div>
            </div>
        </div>
    </div>

    <script>
        // ==================== é…ç½® ====================
        // æ³¨æ„ï¼šéœ€è¦ç”¨æˆ·é…ç½®è¿™äº›å€¼
        const SUPABASE_CONFIG = {
            url: 'https://htqqqapzvjmcuugcgxub.supabase.co',
            anonKey: 'YOUR_ANON_KEY_HERE'
        };

        // ==================== çŠ¶æ€ ====================
        let supabase = null;
        let currentUser = null;
        let todayData = {
            date: new Date().toISOString().split('T')[0],
            breakfast: [],
            lunch: [],
            dinner: [],
            total: 0
        };
        let isOnline = false;

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // 1. åˆå§‹åŒ–Telegram
                if (typeof window.Telegram !== 'undefined') {
                    window.Telegram.WebApp.expand();
                }
                
                // 2. åˆå§‹åŒ–Supabase
                await initSupabase();
                
                // 3. åŠ è½½æ•°æ®
                await loadData();
                
                // 4. æ˜¾ç¤ºç•Œé¢
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                updateUI();
                
            } catch (error) {
                showError('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                // é™çº§åˆ°æœ¬åœ°æ¨¡å¼
                loadLocalData();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                updateUI();
            }
        });

        // ==================== Supabaseåˆå§‹åŒ– ====================
        async function initSupabase() {
            if (!SUPABASE_CONFIG.url || !SUPABASE_CONFIG.anonKey || 
                SUPABASE_CONFIG.url.includes('YOUR_') || SUPABASE_CONFIG.anonKey.includes('YOUR_')) {
                console.log('Supabaseæœªé…ç½®ï¼Œä½¿ç”¨ç¦»çº¿æ¨¡å¼');
                isOnline = false;
                return;
            }
            
            supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
            
            // æµ‹è¯•è¿æ¥
            try {
                const { error } = await supabase.from('users').select('count');
                if (error) throw error;
                isOnline = true;
                console.log('Supabaseè¿æ¥æˆåŠŸ');
            } catch (error) {
                console.warn('Supabaseè¿æ¥å¤±è´¥:', error.message);
                isOnline = false;
            }
        }

        // ==================== æ•°æ®æ“ä½œ ====================
        async function loadData() {
            if (isOnline) {
                await loadCloudData();
            } else {
                loadLocalData();
            }
        }

        async function loadCloudData() {
            // ç®€åŒ–ç‰ˆæœ¬ï¼Œå…ˆä¸å®ç°å®Œæ•´äº‘ç«¯åŠ è½½
            console.log('äº‘ç«¯æ•°æ®åŠ è½½ï¼ˆç®€åŒ–ç‰ˆï¼‰');
            loadLocalData();
        }

        function loadLocalData() {
            const saved = localStorage.getItem('calorie-tracker-v2');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.today.date === todayData.date) {
                        todayData = data.today;
                    }
                } catch (e) {
                    console.error('åŠ è½½æœ¬åœ°æ•°æ®å¤±è´¥:', e);
                }
            }
        }

        function saveData() {
            // è®¡ç®—æ€»çƒ­é‡
            todayData.total = calculateTotalCalories();
            
            // ä¿å­˜åˆ°æœ¬åœ°
            localStorage.setItem('calorie-tracker-v2', JSON.stringify({
                today: todayData,
                lastSaved: new Date().toISOString()
            }));
            
            // å°è¯•åŒæ­¥åˆ°äº‘ç«¯
            if (isOnline) {
                syncToCloud();
            }
        }

        async function syncToCloud() {
            // ç®€åŒ–ç‰ˆæœ¬ï¼Œå…ˆä¸å®ç°å®Œæ•´åŒæ­¥
            console.log('åŒæ­¥åˆ°äº‘ç«¯ï¼ˆç®€åŒ–ç‰ˆï¼‰');
        }

        // ==================== UIæ“ä½œ ====================
        function updateUI() {
            // æ›´æ–°å„é¤æ€»çƒ­é‡
            document.getElementById('breakfastTotal').textContent = 
                calculateMealCalories('breakfast') + ' kcal';
            document.getElementById('lunchTotal').textContent = 
                calculateMealCalories('lunch') + ' kcal';
            document.getElementById('dinnerTotal').textContent = 
                calculateMealCalories('dinner') + ' kcal';
            
            // æ›´æ–°æ€»çƒ­é‡
            const total = calculateTotalCalories();
            document.getElementById('totalCalories').textContent = total + ' kcal';
            
            // æ›´æ–°å‰©ä½™çƒ­é‡
            const goal = 2000;
            document.getElementById('remainingCalories').textContent = Math.max(0, goal - total);
            
            // æ›´æ–°é£Ÿç‰©åˆ—è¡¨
            updateFoodList('breakfast', 'breakfastList');
            updateFoodList('lunch', 'lunchList');
            updateFoodList('dinner', 'dinnerList');
        }

        function updateFoodList(mealType, elementId) {
            const element = document.getElementById(elementId);
            const items = todayData[mealType];
            
            if (items.length === 0) {
                element.innerHTML = '<div style="color: #999; padding: 10px; text-align: center;">æš‚æ— è®°å½•</div>';
                return;
            }
            
            let html = '';
            items.forEach((item, index) => {
                html += `
                    <div class="food-item">
                        <span>${item.name}</span>
                        <div>
                            <span>${item.calories} kcal</span>
                            <button onclick="removeFood('${mealType}', ${index})" style="
                                margin-left: 10px;
                                background: #ff6b6b;
                                color: white;
                                border: none;
                                border-radius: 3px;
                                padding: 2px 6px;
                                font-size: 12px;
                                cursor: pointer;
                            ">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            });
            
            element.innerHTML = html;
        }

        // ==================== ä¸šåŠ¡é€»è¾‘ ====================
        function addFood(mealType) {
            const inputId = mealType + 'Input';
            const caloriesId = mealType + 'Calories';
            
            const name = document.getElementById(inputId).value.trim();
            const calories = parseInt(document.getElementById(caloriesId).value) || 0;
            
            if (!name) {
                showError('è¯·è¾“å…¥é£Ÿç‰©åç§°');
                return;
            }
            
            if (calories <= 0) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„çƒ­é‡å€¼');
                return;
            }
            
            todayData[mealType].push({ name, calories });
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById(inputId).value = '';
            document.getElementById(caloriesId).value = '';
            
            // ä¿å­˜å¹¶æ›´æ–°
            saveData();
            updateUI();
            
            showSuccess(`å·²æ·»åŠ : ${name}`);
        }

        function removeFood(mealType, index) {
            todayData[mealType].splice(index, 1);
            saveData();
            updateUI();
        }

        function calculateMealCalories(mealType) {
            return todayData[mealType].reduce((sum, item) => sum + item.calories, 0);
        }

        function calculateTotalCalories() {
            return calculateMealCalories('breakfast') + 
                   calculateMealCalories('lunch') + 
                   calculateMealCalories('dinner');
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function showError(message) {
            const element = document.getElementById('errorMessage');
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => element.style.display = 'none', 3000);
        }

        function showSuccess(message) {
            const element = document.getElementById('successMessage');
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => element.style.display = 'none', 3000);
        }
    </script>
</body>
</html>
